# Test add_sub_reverse_proxy


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

``` python
from fastcaddy.core import *
from fastcore.test import *
```

``` python
import json
```

``` python
def print_json(j): print(json.dumps(j))
```

``` python
pcfg({})
```

``` python
cf_token = 'DUMMY_TOKEN'
```

``` python
setup_caddy(cf_token)
```

At this point our Caddy config is:

``` python
print(gcfg())
```

<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">{</span>
    <span style="color: #008000; text-decoration-color: #008000">'apps'</span>: <span style="font-weight: bold">{</span>
        <span style="color: #008000; text-decoration-color: #008000">'http'</span>: <span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">'servers'</span>: <span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">'srv0'</span>: <span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">'listen'</span>: <span style="font-weight: bold">[</span><span style="color: #008000; text-decoration-color: #008000">':80'</span>, <span style="color: #008000; text-decoration-color: #008000">':443'</span><span style="font-weight: bold">]</span>, <span style="color: #008000; text-decoration-color: #008000">'routes'</span>: <span style="font-weight: bold">[]}}}</span>,
        <span style="color: #008000; text-decoration-color: #008000">'tls'</span>: <span style="font-weight: bold">{</span>
            <span style="color: #008000; text-decoration-color: #008000">'automation'</span>: <span style="font-weight: bold">{</span>
                <span style="color: #008000; text-decoration-color: #008000">'policies'</span>: <span style="font-weight: bold">[{</span><span style="color: #008000; text-decoration-color: #008000">'issuers'</span>: <span style="font-weight: bold">[{</span><span style="color: #008000; text-decoration-color: #008000">'challenges'</span>: <span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">'dns'</span>: <span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">'provider'</span>: <span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">'api_token'</span>: <span style="color: #008000; text-decoration-color: #008000">'DUMMY_TOKEN'</span>, <span style="color: #008000; text-decoration-color: #008000">'name'</span>: 
<span style="color: #008000; text-decoration-color: #008000">'cloudflare'</span><span style="font-weight: bold">}}}</span>, <span style="color: #008000; text-decoration-color: #008000">'module'</span>: <span style="color: #008000; text-decoration-color: #008000">'acme'</span><span style="font-weight: bold">}]}]</span>
            <span style="font-weight: bold">}</span>
        <span style="font-weight: bold">}</span>
    <span style="font-weight: bold">}</span>
<span style="font-weight: bold">}</span>
</pre>

We can confirm that by going to <http://localhost:2019/config/>

## Setup: add wildcard route \*.something.example.com.

This is needed in order to add subroutes to it.

``` python
add_wildcard_route('something.example.com')
```

Now our config should include the wildcard route:

``` python
print(gcfg())
```

<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">{</span>
    <span style="color: #008000; text-decoration-color: #008000">'apps'</span>: <span style="font-weight: bold">{</span>
        <span style="color: #008000; text-decoration-color: #008000">'http'</span>: <span style="font-weight: bold">{</span>
            <span style="color: #008000; text-decoration-color: #008000">'servers'</span>: <span style="font-weight: bold">{</span>
                <span style="color: #008000; text-decoration-color: #008000">'srv0'</span>: <span style="font-weight: bold">{</span>
                    <span style="color: #008000; text-decoration-color: #008000">'listen'</span>: <span style="font-weight: bold">[</span><span style="color: #008000; text-decoration-color: #008000">':80'</span>, <span style="color: #008000; text-decoration-color: #008000">':443'</span><span style="font-weight: bold">]</span>,
                    <span style="color: #008000; text-decoration-color: #008000">'routes'</span>: <span style="font-weight: bold">[{</span><span style="color: #008000; text-decoration-color: #008000">'@id'</span>: <span style="color: #008000; text-decoration-color: #008000">'wildcard-something.example.com'</span>, <span style="color: #008000; text-decoration-color: #008000">'handle'</span>: <span style="font-weight: bold">[{</span><span style="color: #008000; text-decoration-color: #008000">'handler'</span>: <span style="color: #008000; text-decoration-color: #008000">'subroute'</span>, 
<span style="color: #008000; text-decoration-color: #008000">'routes'</span>: <span style="font-weight: bold">[]}]</span>, <span style="color: #008000; text-decoration-color: #008000">'match'</span>: <span style="font-weight: bold">[{</span><span style="color: #008000; text-decoration-color: #008000">'host'</span>: <span style="font-weight: bold">[</span><span style="color: #008000; text-decoration-color: #008000">'*.something.example.com'</span><span style="font-weight: bold">]}]</span>, <span style="color: #008000; text-decoration-color: #008000">'terminal'</span>: <span style="color: #00ff00; text-decoration-color: #00ff00; font-style: italic">True</span><span style="font-weight: bold">}]</span>
                <span style="font-weight: bold">}</span>
            <span style="font-weight: bold">}</span>
        <span style="font-weight: bold">}</span>,
        <span style="color: #008000; text-decoration-color: #008000">'tls'</span>: <span style="font-weight: bold">{</span>
            <span style="color: #008000; text-decoration-color: #008000">'automation'</span>: <span style="font-weight: bold">{</span>
                <span style="color: #008000; text-decoration-color: #008000">'policies'</span>: <span style="font-weight: bold">[{</span><span style="color: #008000; text-decoration-color: #008000">'issuers'</span>: <span style="font-weight: bold">[{</span><span style="color: #008000; text-decoration-color: #008000">'challenges'</span>: <span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">'dns'</span>: <span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">'provider'</span>: <span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">'api_token'</span>: <span style="color: #008000; text-decoration-color: #008000">'DUMMY_TOKEN'</span>, <span style="color: #008000; text-decoration-color: #008000">'name'</span>: 
<span style="color: #008000; text-decoration-color: #008000">'cloudflare'</span><span style="font-weight: bold">}}}</span>, <span style="color: #008000; text-decoration-color: #008000">'module'</span>: <span style="color: #008000; text-decoration-color: #008000">'acme'</span><span style="font-weight: bold">}]}]</span>
            <span style="font-weight: bold">}</span>
        <span style="font-weight: bold">}</span>
    <span style="font-weight: bold">}</span>
<span style="font-weight: bold">}</span>
</pre>

At this point there are no subroutes associated with that
`*.something.example.com` wildcard. When that is matched, the handlers
list is empty untilâ€¦

## Add subroute 1: foo.something.example.com

``` python
add_sub_reverse_proxy('something.example.com', 'foo', 5001)
```

``` python
print(gcfg('/apps/http/servers/srv0/routes/0/handle'))
```

<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">[{</span><span style="color: #008000; text-decoration-color: #008000">'handler'</span>: <span style="color: #008000; text-decoration-color: #008000">'subroute'</span>, <span style="color: #008000; text-decoration-color: #008000">'routes'</span>: <span style="font-weight: bold">[{</span><span style="color: #008000; text-decoration-color: #008000">'@id'</span>: <span style="color: #008000; text-decoration-color: #008000">'foo.something.example.com'</span>, <span style="color: #008000; text-decoration-color: #008000">'handle'</span>: <span style="font-weight: bold">[{</span><span style="color: #008000; text-decoration-color: #008000">'handler'</span>: <span style="color: #008000; text-decoration-color: #008000">'reverse_proxy'</span>, 
<span style="color: #008000; text-decoration-color: #008000">'upstreams'</span>: <span style="font-weight: bold">[{</span><span style="color: #008000; text-decoration-color: #008000">'dial'</span>: <span style="color: #008000; text-decoration-color: #008000">'localhost:5001'</span><span style="font-weight: bold">}]}]</span>, <span style="color: #008000; text-decoration-color: #008000">'match'</span>: <span style="font-weight: bold">[{</span><span style="color: #008000; text-decoration-color: #008000">'host'</span>: <span style="font-weight: bold">[</span><span style="color: #008000; text-decoration-color: #008000">'foo.something.example.com'</span><span style="font-weight: bold">]}]}]}]</span>
</pre>

Now we can see the `handle` config with the list of sub-routes and the
sub-route handler.

``` python
print(gcfg('/apps/http/servers/srv0/routes/0/handle/0/routes'))
```

<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">[{</span><span style="color: #008000; text-decoration-color: #008000">'@id'</span>: <span style="color: #008000; text-decoration-color: #008000">'foo.something.example.com'</span>, <span style="color: #008000; text-decoration-color: #008000">'handle'</span>: <span style="font-weight: bold">[{</span><span style="color: #008000; text-decoration-color: #008000">'handler'</span>: <span style="color: #008000; text-decoration-color: #008000">'reverse_proxy'</span>, <span style="color: #008000; text-decoration-color: #008000">'upstreams'</span>: <span style="font-weight: bold">[{</span><span style="color: #008000; text-decoration-color: #008000">'dial'</span>: 
<span style="color: #008000; text-decoration-color: #008000">'localhost:5001'</span><span style="font-weight: bold">}]}]</span>, <span style="color: #008000; text-decoration-color: #008000">'match'</span>: <span style="font-weight: bold">[{</span><span style="color: #008000; text-decoration-color: #008000">'host'</span>: <span style="font-weight: bold">[</span><span style="color: #008000; text-decoration-color: #008000">'foo.something.example.com'</span><span style="font-weight: bold">]}]}]</span>
</pre>

We can see that:

1.  A route with id `foo.something.example.com` was created.

``` python
test_eq(gcfg('/apps/http/servers/srv0/routes/0/handle/0/routes/0/@id'), 'foo.something.example.com')
```

2.  It matches requests for `foo.something.example.com`

``` python
test_eq(gcfg('apps/http/servers/srv0/routes/0/handle/0/routes/0/match/0/host/0'), 'foo.something.example.com')
```

3.  When a request for `foo.something.example.com` is matched, its
    handler is a reverse proxy to `localhost:5001`.

``` python
test_eq(gcfg('apps/http/servers/srv0/routes/0/handle/0/routes/0/handle/0/upstreams/0/dial'), 'localhost:5001')
```

## Add subroute 2: bar.something.example.com

``` python
add_sub_reverse_proxy('something.example.com', 'bar', 5002)
```

``` python
print(gcfg('/apps/http/servers/srv0/routes/0/handle'))
```

<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">[{</span><span style="color: #008000; text-decoration-color: #008000">'handler'</span>: <span style="color: #008000; text-decoration-color: #008000">'subroute'</span>, <span style="color: #008000; text-decoration-color: #008000">'routes'</span>: <span style="font-weight: bold">[{</span><span style="color: #008000; text-decoration-color: #008000">'@id'</span>: <span style="color: #008000; text-decoration-color: #008000">'foo.something.example.com'</span>, <span style="color: #008000; text-decoration-color: #008000">'handle'</span>: <span style="font-weight: bold">[{</span><span style="color: #008000; text-decoration-color: #008000">'handler'</span>: <span style="color: #008000; text-decoration-color: #008000">'reverse_proxy'</span>, 
<span style="color: #008000; text-decoration-color: #008000">'upstreams'</span>: <span style="font-weight: bold">[{</span><span style="color: #008000; text-decoration-color: #008000">'dial'</span>: <span style="color: #008000; text-decoration-color: #008000">'localhost:5001'</span><span style="font-weight: bold">}]}]</span>, <span style="color: #008000; text-decoration-color: #008000">'match'</span>: <span style="font-weight: bold">[{</span><span style="color: #008000; text-decoration-color: #008000">'host'</span>: <span style="font-weight: bold">[</span><span style="color: #008000; text-decoration-color: #008000">'foo.something.example.com'</span><span style="font-weight: bold">]}]}</span>, <span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">'@id'</span>: 
<span style="color: #008000; text-decoration-color: #008000">'bar.something.example.com'</span>, <span style="color: #008000; text-decoration-color: #008000">'handle'</span>: <span style="font-weight: bold">[{</span><span style="color: #008000; text-decoration-color: #008000">'handler'</span>: <span style="color: #008000; text-decoration-color: #008000">'reverse_proxy'</span>, <span style="color: #008000; text-decoration-color: #008000">'upstreams'</span>: <span style="font-weight: bold">[{</span><span style="color: #008000; text-decoration-color: #008000">'dial'</span>: <span style="color: #008000; text-decoration-color: #008000">'localhost:5002'</span><span style="font-weight: bold">}]}]</span>, 
<span style="color: #008000; text-decoration-color: #008000">'match'</span>: <span style="font-weight: bold">[{</span><span style="color: #008000; text-decoration-color: #008000">'host'</span>: <span style="font-weight: bold">[</span><span style="color: #008000; text-decoration-color: #008000">'bar.something.example.com'</span><span style="font-weight: bold">]}]}]}]</span>
</pre>

Now we see a single sub-route handler containing two routes.

``` python
print(gcfg('/apps/http/servers/srv0/routes/0/handle/0/routes'))
```

<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">[{</span><span style="color: #008000; text-decoration-color: #008000">'@id'</span>: <span style="color: #008000; text-decoration-color: #008000">'foo.something.example.com'</span>, <span style="color: #008000; text-decoration-color: #008000">'handle'</span>: <span style="font-weight: bold">[{</span><span style="color: #008000; text-decoration-color: #008000">'handler'</span>: <span style="color: #008000; text-decoration-color: #008000">'reverse_proxy'</span>, <span style="color: #008000; text-decoration-color: #008000">'upstreams'</span>: <span style="font-weight: bold">[{</span><span style="color: #008000; text-decoration-color: #008000">'dial'</span>: 
<span style="color: #008000; text-decoration-color: #008000">'localhost:5001'</span><span style="font-weight: bold">}]}]</span>, <span style="color: #008000; text-decoration-color: #008000">'match'</span>: <span style="font-weight: bold">[{</span><span style="color: #008000; text-decoration-color: #008000">'host'</span>: <span style="font-weight: bold">[</span><span style="color: #008000; text-decoration-color: #008000">'foo.something.example.com'</span><span style="font-weight: bold">]}]}</span>, <span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">'@id'</span>: <span style="color: #008000; text-decoration-color: #008000">'bar.something.example.com'</span>, 
<span style="color: #008000; text-decoration-color: #008000">'handle'</span>: <span style="font-weight: bold">[{</span><span style="color: #008000; text-decoration-color: #008000">'handler'</span>: <span style="color: #008000; text-decoration-color: #008000">'reverse_proxy'</span>, <span style="color: #008000; text-decoration-color: #008000">'upstreams'</span>: <span style="font-weight: bold">[{</span><span style="color: #008000; text-decoration-color: #008000">'dial'</span>: <span style="color: #008000; text-decoration-color: #008000">'localhost:5002'</span><span style="font-weight: bold">}]}]</span>, <span style="color: #008000; text-decoration-color: #008000">'match'</span>: <span style="font-weight: bold">[{</span><span style="color: #008000; text-decoration-color: #008000">'host'</span>: 
<span style="font-weight: bold">[</span><span style="color: #008000; text-decoration-color: #008000">'bar.something.example.com'</span><span style="font-weight: bold">]}]}]</span>
</pre>

Here we see that:

1.  The `foo.something.example.com` subroute is still present.

``` python
test_eq(gcfg('/apps/http/servers/srv0/routes/0/handle/0/handler'), 'subroute')
```

2.  A route with id `bar.something.example.com` was created.

``` python
test_eq(gcfg('/apps/http/servers/srv0/routes/0/handle/0/routes/1/@id'), 'bar.something.example.com')
```

3.  It matches requests for `bar.something.example.com`

``` python
test_eq(gcfg('/apps/http/servers/srv0/routes/0/handle/0/routes/1/match/0/host/0'),'bar.something.example.com')
```

4.  When a request for `bar.something.example.com` is matched, its
    handler is a reverse proxy to `localhost:5002`.

``` python
test_eq(gcfg('/apps/http/servers/srv0/routes/0/handle/0/routes/1/handle/0/upstreams/0/dial'), 'localhost:5002')
```

## Add multi-port subroute

``` python
add_sub_reverse_proxy('something.example.com', 'multiport', [5003, 5004])
```

``` python
print(gcfg('/apps/http/servers/srv0/routes/0/handle/0/routes/2/handle/0/upstreams'))
```

<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">[{</span><span style="color: #008000; text-decoration-color: #008000">'dial'</span>: <span style="color: #008000; text-decoration-color: #008000">'localhost:5003'</span><span style="font-weight: bold">}</span>, <span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">'dial'</span>: <span style="color: #008000; text-decoration-color: #008000">'localhost:5004'</span><span style="font-weight: bold">}]</span>
</pre>

``` python
test_eq[{'dial': 'localhost:5003'}, {'dial': 'localhost:5004'}]
```
